---
# This installs several malware/rootkit/virus detection utilities.
# All of these programs are configured to run daily or weekly, and to scan as
# much of the entire system as possible.

- name: Download Lynix Repository Key
  apt_key: url=http://packages.cisofy.com/keys/cisofy-software-public.key state=present
  tags:
    - dependencies

- name: Add Lynis Repository
  apt_repository: repo="deb https://packages.cisofy.com/community/lynis/deb/ testing main"
  tags:
    - dependencies

# ed and inotify are needed for maldet
- name: Install Malware Detection Packages
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - lynis
    - rkhunter
    - unhide
    - clamav-daemon
    - clamsmtp
    - inotify-tools
    - ed
  tags:
    - dependencies

- name: Download Linux Malware Detect Installer
  unarchive:
    src=http://www.rfxn.com/downloads/maldetect-current.tar.gz
    dest=/root
    remote_src=yes

- name: Get Current Linux Malware Detect Version
  shell: "ls -d /root/maldetect*"
  register: lmd_version
  changed_when: false

- name: Install Linux Malware Detect
  shell: "{{ lmd_version.stdout }}/install.sh chdir={{ lmd_version.stdout }} creates=/usr/local/maldetect"

- name: Remove Malware Detect Installation Files
  file: path={{ lmd_version.stdout }} state=absent

- name: Copy Linux Malware Detect Configuration
  template: src=usr_local_maldetect_conf.maldet.j2 dest=/usr/local/maldetect/conf.maldet
  notify: restart maldet

- name: Adjust Malware Detect's Ignored Paths
  copy: src=usr_local_maldetect_ignore_paths dest=/usr/local/maldetect/ignore_paths
  notify: restart maldet

- name: Add Root Directory to Malware Detect's Monitoring
  copy:
    content: "/\n"
    dest: /usr/local/maldetect/monitor_paths
    mode: 0644
  notify: restart maldet

# https://github.com/rfxn/linux-malware-detect/issues/28 is why a custom logrotate
# is needed.
- name: Install Malware Detect's Logrotate
  copy: src=etc_logrotate.d_maldet dest=/etc/logrotate.d/maldet

- name: Create Monthly Malware Detect Upgrade
  cron: name="LMD update" special_time=monthly job="/usr/local/sbin/maldet --update-ver"

- name: Copy rkhunter Configuration
  copy: src={{ item.src }} dest={{ item.dest }} group=root owner=root
  with_items:
  - { src: 'etc_default_rkhunter', dest: '/etc/default/rkhunter' }
  - { src: 'etc_rkhunter.conf.local', dest: '/etc/rkhunter.conf.local' }

- name: Create rkhunter's Database Of System Files
  command: rkhunter --propupd
    creates=/var/lib/rkhunter/db/rkhunter.dat

- name: Create Lynis Log Directory
  file: state=directory path=/var/log/lynis mode=0755

- name: Copy Lynis Weekly Cronjob Task
  template: src=etc_cron.weekly_lynis.j2 dest=/etc/cron.weekly/lynis mode=0755

- name: Copy ClamAV Configuration
  copy: src=etc_clamav_clamd.conf dest=/etc/clamav/clamd.conf mode=0644

- name: Copy Daily ClamAV Scan Task
  template: src=etc_cron.daily_clamav.j2 dest=/etc/cron.daily/clamav mode=0755

- name: Copy ClamSMTP Configuration
  copy: src=etc_clamsmtpd.conf dest=/etc/clamsmtpd.conf

- name: Copy ClamSMTP Virus Action Script
  template: src=usr_local_bin_clamsmtp-action.sh.j2 dest=/usr/local/bin/clamsmtp-action.sh owner=clamsmtp group=clamsmtp mode=0755

- name: Ensure Services Are Started & Enabled
  service: name={{ item }} state=started enabled=yes
  with_items:
    - clamav-daemon
    - clamav-freshclam
    - clamsmtp
    - maldet
