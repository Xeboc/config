---
# Install and configure packages related to security

- name: Ensure repository key for Lynis is in place
  apt_key: url=http://packages.cisofy.com/keys/cisofy-software-public.key state=present
  tags:
    - dependencies

- name: Add Lynis repository
  apt_repository: repo="deb https://packages.cisofy.com/community/lynis/deb/ {{ ansible_distribution_release }} main"
  tags:
    - dependencies

- name: Install security-related packages
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - fail2ban
    - whois
    - lynis
    - rkhunter
    - apparmor
    - apparmor-profiles
    - apparmor-profiles-extra
    - apparmor-utils
  tags:
    - dependencies

- name: get public IP
  ipify_facts:

- name: Copy fail2ban configuration into place
  template: src=etc_fail2ban_jail.local.j2 dest=/etc/fail2ban/jail.local
  notify: restart fail2ban

- name: Copy fail2ban dovecot configuration into place
  copy: src=etc_fail2ban_filter.d_dovecot-pop3imap.conf dest=/etc/fail2ban/filter.d/dovecot-pop3imap.conf
  notify: restart fail2ban

- name: Ensure fail2ban is started
  service: name=fail2ban state=started

- name: Update sshd config for PFS and more secure defaults
  template: src=etc_ssh_sshd_config.j2 dest=/etc/ssh/sshd_config
  notify: restart ssh

- name: Update ssh config for more secure defaults
  template: src=etc_ssh_ssh_config.j2 dest=/etc/ssh/ssh_config

- name: Update rkhunter config file for non-existant location
  lineinfile: dest=/etc/rkhunter.conf
              regexp=^SCRIPTWHITELIST=/usr/bin/lwp-request
              line="#SCRIPTWHITELIST=/usr/bin/lwp-request"
              state=present
              backrefs=yes

- name: Create Lynis log directory
  file: state=directory path=/var/log/lynis mode=0755

- name: Copy Lynis cronjob task
  template: src=etc_cron.weekly_lynis dest=/etc/cron.weekly/lynis mode=0755
