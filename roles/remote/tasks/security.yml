---
# Install and configure packages related to security

- name: Install security-related packages
  apt: pkg={{ item }} state=installed update_cache=yes
  with_items:
    - whois
    - apparmor
    - apparmor-profiles
    - apparmor-profiles-extra
    - apparmor-utils
  tags:
    - dependencies

- name: Update sshd config for more secure defaults
  template: src=etc_ssh_sshd_config.j2 dest=/etc/ssh/sshd_config
  notify: restart ssh

- name: Update ssh config for more secure defaults
  template: src=etc_ssh_ssh_config.j2 dest=/etc/ssh/ssh_config

- name: Adjust login password defaults and umask
  lineinfile: dest=/etc/login.defs regexp="{{ item.regexp }}" line="{{ item.line}}" backup=yes state=present backrefs=yes
  with_items:
    - { regexp: ^UMASK, line: "UMASK   027" }
    - { regexp: ^PASS_MIN_DAYS, line: "PASS_MIN_DAYS 1" }
    - { regexp: ^PASS_MAX_DAYS, line: "PASS_MAX_DAYS 980" }
    - { regexp: ^PASS_WARN_AGE, line: "PASS_WARN_AGE 21" }

- name: Adjust init.d/rc umask
  lineinfile: dest=/etc/init.d/rc regexp=^umask line="umask 027" backup=yes state=present backrefs=yes
